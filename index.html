<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Merge Axolotls!</title>
<!-- Crypto-JS for encryption -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    text-align: center;
    background: linear-gradient(135deg, #e0f7fa, #c5cae9);
    color: #333;
    padding: 20px;
    margin: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
      margin-bottom: 5px;
  }
  #gameArea {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 20px;
  }
  #stats {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(5px);
    padding: 10px 20px;
    margin-bottom: 20px;
    border-radius: 20px;
    display: inline-block;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    font-size: 1.2em;
    font-weight: bold;
  }
  #grid {
    display: grid;
    grid-template-columns: repeat(3, 100px);
    grid-gap: 12px;
    justify-content: center;
    margin-bottom: 20px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(5px);
    border-radius: 20px;
    box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1);
  }
  #nameInputContainer, #rightSidebar {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(5px);
    padding: 15px;
    border-radius: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  #rightSidebar {
    width: 200px;
    gap: 10px;
  }
  #nameInputContainer label {
    font-size: 1.1em;
    font-weight: bold;
    color: #444;
  }
  #nameInputContainer input, #rightSidebar input {
    padding: 8px;
    width: 120px;
    margin-top: 10px;
    border-radius: 10px;
    border: 2px solid #aaa;
    text-align: center;
    font-size: 1em;
  }
  .cell {
    width: 100px;
    height: 100px;
    background: white;
    border: 3px solid #6c7e97;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 12px;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  .cell:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
  }
  .cell.selected {
      border: 3px solid #ff4d4d;
  }
  .axolotl-svg {
    width: 50px;
    height: 50px;
  }
  button {
    display: block;
    width: 300px;
    margin: 15px auto;
    padding: 12px 20px;
    font-size: 1.1em;
    font-weight: bold;
    border-radius: 25px;
    border: none;
    cursor: pointer;
    color: white;
    background-size: 200% auto;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }
  .buy-axolotl {
    background-image: linear-gradient(to right, #6a11cb 0%, #2575fc 50%, #6a11cb 100%);
  }
  .buy-ingot {
    background-image: linear-gradient(to right, #ff7e5f 0%, #feb47b 50%, #ff7e5f 100%);
  }
  .buy-auto-merge {
    background-image: linear-gradient(to right, #e87b28 0%, #d85c15 50%, #e87b28 100%);
  }
  .expand-grid {
    background-image: linear-gradient(to right, #00c6ff 0%, #0072ff 50%, #00c6ff 100%);
  }
  .save-load-btn {
    background-image: linear-gradient(to right, #11998e 0%, #38ef7d 50%, #11998e 100%);
  }
  .reset-btn {
    background-image: linear-gradient(to right, #ff416c 0%, #ff4b2b 50%, #ff416c 100%);
  }
  .discord-btn {
    background-image: linear-gradient(to right, #5865F2 0%, #7289DA 50%, #5865F2 100%);
  }
  .prestige-btn {
    background-image: linear-gradient(to right, #7b4397 0%, #dc2430 50%, #7b4397 100%);
  }
  .surprise-btn {
    background-image: linear-gradient(to right, #ffd700 0%, #ff8c00 50%, #ffd700 100%);
  }
  button:hover {
    background-position: right center;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
  }
  button:disabled {
    background-image: linear-gradient(to right, #c0c0c0 0%, #a0a0a0 50%, #c0c0c0 100%);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    transform: translateY(0);
    cursor: not-allowed;
  }
  
  .button-group {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
  }
  .button-group button {
      width: 200px;
      margin: 0;
  }
  #save-load-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 20px;
  }

  /* New save feedback message */
  #saveFeedback {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 15px;
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      pointer-events: none;
      font-size: 1em;
  }
  #saveFeedback.visible {
      opacity: 1;
  }
  
  /* Achievements Notification */
  #achievementNotification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 15px;
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      pointer-events: none;
      font-size: 1em;
      min-width: 200px;
  }
  #achievementNotification.visible {
      opacity: 1;
  }

  #modalOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
  }
  #modalContent {
      background: #fff;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      text-align: center;
      width: 90%;
      max-width: 500px;
  }
  #modalContent input, #modalContent label {
      width: 80%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
  }
  #modalContent button {
      width: auto;
      margin: 5px;
  }
  #howToPlayContainer {
      margin-top: 20px;
  }

  /* Achievements styles */
  #achievementsList {
      list-style-type: none;
      padding: 0;
      text-align: left;
      /* Add these lines to make the list scrollable */
      max-height: 400px; /* Adjust this value as needed */
      overflow-y: auto;
  }
  .achievement-item {
      display: flex;
      align-items: center;
      background: #eee;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 8px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      position: relative; /* For positioning the status label */
  }
  .achievement-item.unlocked {
      background: #d4edda;
      border: 2px solid #28a745;
  }
  .achievement-status {
    position: absolute;
    top: 5px;
    right: 10px;
    font-weight: bold;
    font-size: 0.8em;
  }
  .achievement-status.unlocked {
    color: #28a745;
  }
  .achievement-status.locked {
    color: #ff4d4d;
  }
  .achievement-icon {
      font-size: 2em;
      margin-right: 15px;
  }
  .achievement-details {
      flex-grow: 1;
  }
  .achievement-details h4 {
      margin: 0 0 5px 0;
      font-size: 1.1em;
  }
  .achievement-details p {
      margin: 0;
      font-size: 0.9em;
  }
</style>
</head>
<body>

<h1>Merge Axolotls!</h1>
<div id="stats">
  Coins: <span id="coins">0</span> |
  Passive Income: <span id="income">0</span>/sec |
  🪙 <span id="ingots">0</span><span id="goldBadge" style="display:none; margin-left: 10px; font-size: 1.5em; vertical-align: middle;">🥇</span> |
  ✨ Multiplier: <span id="multiplierDisplay">1x coins, 1x ingots</span>
</div>

<div id="gameArea">
  <div id="grid"></div>
  <div id="rightSidebar">
    <div id="nameInputContainer">
      <label for="axolotlNameInput">Name Axolotls</label>
      <input type="text" id="axolotlNameInput" maxlength="7" placeholder="Name">
    </div>
    <div id="mergeAllContainer">
      <label for="mergeLevelInput">Merge all Level:</label>
      <input type="number" id="mergeLevelInput" min="1" max="100" value="1" style="width: 60px;">
      <button id="mergeAllBtn" class="buy-auto-merge" style="width:100%;" onclick="mergeAllOfSelectedLevel()">Merge (200 Coins)</button>
    </div>
  </div>
</div>

<button id="buyAxolotlBtn" class="buy-axolotl" onclick="buyAxolotl()">Buy Lvl 1 Axolotl (10 Coins)</button>
<div class="button-group">
  <button id="buyIngotBtn" class="buy-ingot" onclick="buyIngot()">Buy Gold Ingot (1K Coins)</button>
  <button id="buy10IngotsBtn" class="buy-ingot" onclick="buy10Ingots()">Buy 10 Ingots (9.75K Coins)</button>
  <button id="buy100IngotsBtn" class="buy-ingot" onclick="buy100Ingots()">Buy 100 Ingots (95K Coins)</button>
</div>
<button id="expandGridBtn" class="expand-grid" onclick="expandGrid()">Expand Grid</button>
<button id="autoMergeBtn" class="buy-auto-merge" onclick="buyAutoMerge()">Buy Auto Merge Lvl 1 (1K Ingots)</button>
<button id="prestigeBtn" class="prestige-btn" onclick="showModal('prestige')">Prestige (1M Coins)</button>
<button id="buyGoldBadgeBtn" class="surprise-btn" onclick="buyGoldBadge()">Buy Gold Ingot Badge (10M Ingots)</button>

<!-- New How To Play Button -->
<div id="howToPlayContainer">
    <button class="save-load-btn" onclick="showModal('howToPlay')">How to Play</button>
</div>
<button class="save-load-btn" onclick="showModal('achievements')">View Achievements</button>

<h3>Socials & Settings</h3>
<button class="discord-btn" onclick="window.open('https://discord.gg/HhSK2VsvP5', '_blank')">Join my Discord server!</button>
<div id="save-load-group">
    <h4>Copy/Paste Save ID</h4>
    <button id="copySaveBtn" class="save-load-btn" onclick="copySaveData()">Copy Save ID</button>
    <button class="save-load-btn" onclick="showModal('import')">Import Save ID</button>
</div>
<button class="reset-btn" onclick="resetGame()">Reset Game</button>

<div id="saveFeedback">Game Saved!</div>
<div id="achievementNotification"></div>


<!-- Combined Modal Container -->
<div id="modalContainer" style="display:none;">
    <div id="modalOverlay">
        <div id="modalContent">
            <!-- Content will be dynamically added here -->
        </div>
    </div>
</div>

<script>
  const AES_KEY = "super-secret-key-that-is-not-very-secret";
  const colors = ["#4CAF50", "#2196F3", "#FF9800", "#9C27B0", "#E91E63", "#FFEB3B", "#00BCD4", "#795548", "#8BC34A", "#F4436A"];
  let gridSize = 3;
  let grid = new Array(gridSize * gridSize).fill(0);
  let coins = 0;
  let ingots = 0;
  let selected = null;
  let axolotlName = "";
  let autoMergeLevel = 0;
  let autoMergeInterval = null;
  const maxPassive = 5000;
  let consentGiven = false;
  let autoSaveInterval = null;
  // Prestige-related variables
  let prestigeBought = false;
  let ingotGainMultiplier = 1;
  let coinGainMultiplier = 1;
  const ingot_surprise_chance = 0.01;
  const super_merge_chance = 0.01;
  let hasGoldBadge = false; 
  let highestAxolotlLevel = 0;

  const cost_axolotl = 10;
  const cost_ingot = 1000;
  const cost_10_ingots = 9750;
  const cost_100_ingots = 95000;
  const expand_costs = { 3: 100, 4: 500 };
  const autoMerge_costs = [1000, 2000, 5000];
  const prestige_cost = 1000000;
  const cost_gold_badge = 10000000;
  const cost_merge_all = 200;

  const prestige_ingot_bonus = 5;
  const prestige_coin_bonus = 2;

  const gridDiv = document.getElementById('grid');
  const coinsSpan = document.getElementById('coins');
  const incomeSpan = document.getElementById('income');
  const ingotsSpan = document.getElementById('ingots');
  const multiplierDisplay = document.getElementById('multiplierDisplay');
  const axolotlNameInput = document.getElementById("axolotlNameInput");
  const buyAxolotlBtn = document.getElementById('buyAxolotlBtn');
  const buyIngotBtn = document.getElementById('buyIngotBtn');
  const buy10IngotsBtn = document.getElementById('buy10IngotsBtn');
  const buy100IngotsBtn = document.getElementById('buy100IngotsBtn');
  const expandGridBtn = document.getElementById('expandGridBtn');
  const autoMergeBtn = document.getElementById('autoMergeBtn');
  const prestigeBtn = document.getElementById('prestigeBtn');
  const buyGoldBadgeBtn = document.getElementById('buyGoldBadgeBtn');
  const goldBadgeSpan = document.getElementById('goldBadge');
  const saveFeedback = document.getElementById('saveFeedback');
  const achievementNotification = document.getElementById('achievementNotification');
  const modalContainer = document.getElementById('modalContainer');
  const modalContent = document.getElementById('modalContent');
  const mergeLevelInput = document.getElementById('mergeLevelInput');
  const mergeAllBtn = document.getElementById('mergeAllBtn');

  // Achievements data structure
  let achievements = {
    'coins_500': { name: "A Little Something", description: "Get 500 coins", unlocked: false, threshold: 500, type: 'coins', icon: '💰' },
    'coins_5k': { name: "Coin Collector", description: "Get 5K coins", unlocked: false, threshold: 5000, type: 'coins', icon: '🪙' },
    'coins_500k': { name: "Wealthy Axolotl", description: "Get 500K coins", unlocked: false, threshold: 500000, type: 'coins', icon: '💎' },
    'coins_1m': { name: "Millionaire", description: "Get 1M coins", unlocked: false, threshold: 1000000, type: 'coins', icon: '💰' },
    'coins_10m': { name: "Tycoon", description: "Get 10M coins", unlocked: false, threshold: 10000000, type: 'coins', icon: '👑' },
    'coins_100m': { name: "Mogul", description: "Get 100M coins", unlocked: false, threshold: 100000000, type: 'coins', icon: '🏛️' },
    'coins_1b': { name: "Billionaire", description: "Get 1B coins", unlocked: false, threshold: 1000000000, type: 'coins', icon: '🚀' },
    'ingots_1': { name: "First Ingot", description: "Get 1 ingot", unlocked: false, threshold: 1, type: 'ingots', icon: '🧱' },
    'ingots_10': { name: "Ingot Hoarder", description: "Get 10 ingots", unlocked: false, threshold: 10, type: 'ingots', icon: '🧱' },
    'ingots_100': { name: "Ingot Baron", description: "Get 100 ingots", unlocked: false, threshold: 100, type: 'ingots', icon: '🧱' },
    'ingots_1k': { name: "Ingot King", description: "Get 1K ingots", unlocked: false, threshold: 1000, type: 'ingots', icon: '🌟' },
    'ingots_10k': { name: "Ingot Lord", description: "Get 10K ingots", unlocked: false, threshold: 10000, type: 'ingots', icon: '🌟' },
    'ingots_100k': { name: "Ingot God", description: "Get 100K ingots", unlocked: false, threshold: 100000, type: 'ingots', icon: '💎' },
    'ingots_500k': { name: "Ingot Emperor", description: "Get 500K ingots", unlocked: false, threshold: 500000, type: 'ingots', icon: '👑' },
    'ingots_1m': { name: "Ingot Overlord", description: "Get 1M ingots", unlocked: false, threshold: 1000000, type: 'ingots', icon: '🚀' },
    'level_5': { name: "Level Up!", description: "Get an Axolotl of level 5", unlocked: false, threshold: 5, type: 'level', icon: '⭐' },
    'level_10': { name: "Master Mergist", description: "Get an Axolotl of level 10", unlocked: false, threshold: 10, type: 'level', icon: '🏅' },
    'level_20': { name: "Axolotl Master", description: "Get an Axolotl of level 20", unlocked: false, threshold: 20, type: 'level', icon: '🏆' },
    'level_100': { name: "Axolotl God", description: "Get an Axolotl of level 100", unlocked: false, threshold: 100, type: 'level', icon: '🔥' },
    'automerge': { name: "Auto-Merger", description: "Get Auto Merge", unlocked: false, threshold: 1, type: 'automerge', icon: '🤖' },
    'prestige': { name: "Prestiged!", description: "Prestige for the first time", unlocked: false, threshold: 1, type: 'prestige', icon: '🌟' },
    'goldbadge': { name: "Golden Axolotl", description: "Get the Gold Ingot Badge", unlocked: false, threshold: 1, type: 'goldbadge', icon: '🥇' }
  };

  axolotlNameInput.addEventListener("input", e => {
    axolotlName = e.target.value.slice(0,7);
    renderGrid();
    if (consentGiven) saveToLocalStorage();
  });

  // Helper function to format numbers with K and M
  function formatNumber(num) {
      if (num >= 1000000000) {
          return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
      }
      if (num >= 1000000) {
          return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
      }
      if (num >= 1000) {
          return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
      }
      return num;
  }

  function getAxolotlSVG(color) {
    return `
      <svg class="axolotl-svg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
      <circle cx="32" cy="32" r="16" fill="${color}" stroke="black" stroke-width="2"/>
      <line x1="16" y1="32" x2="0" y2="32" stroke="black" stroke-width="2"/>
      <line x1="48" y1="32" x2="64" y2="32" stroke="black" stroke-width="2"/>
      <circle cx="26" cy="28" r="3" fill="black"/>
      <circle cx="38" cy="28" r="3" fill="black"/>
      <path d="M26 38 Q32 46 38 38" stroke="black" stroke-width="2" fill="none"/>
      </svg>`;
  }

  function renderGrid() {
    gridDiv.style.gridTemplateColumns = `repeat(${gridSize}, 100px)`;
    gridDiv.innerHTML = '';
    grid.forEach((level, idx) => {
      const cell = document.createElement('div');
      cell.className = 'cell';
      if (level > 0) {
        let color = colors[(level - 1) % colors.length];
        cell.innerHTML = getAxolotlSVG(color) + `<div>${axolotlName}-${level}</div>`;
      }
      cell.onclick = () => selectCell(idx, cell);
      gridDiv.appendChild(cell);
    });
    if (selected !== null) {
      gridDiv.children[selected].classList.add("selected");
    }
  }

  function selectCell(idx, cell) {
    if (grid[idx] === 0) return;
    if (selected === null) {
      selected = idx;
      cell.classList.add("selected");
    } else if (selected !== idx && grid[selected] === grid[idx]) {
      let newLevel = grid[selected] + 1;
      // Surprise 1: Super Merge!
      if (Math.random() < super_merge_chance) {
          newLevel++;
          showSaveFeedback("🌟 Super Merge! Your axolotl skipped a level! 🌟");
      }
      coins += newLevel * coinGainMultiplier;
      grid[selected] = newLevel;
      grid[idx] = 0;
      // Surprise 2: Gold Ingot
      if (Math.random() < ingot_surprise_chance) {
        ingots += 1 * ingotGainMultiplier;
        showSaveFeedback("✨ Surprise! You found a Gold Ingot! ✨");
      }
      selected = null;
      highestAxolotlLevel = Math.max(highestAxolotlLevel, newLevel);
      updateIncome();
      renderGrid();
      updateDisplay();
      checkAchievements();
      if (consentGiven) saveToLocalStorage();
    } else {
      selected = null;
      renderGrid();
    }
  }

  function buyAxolotl() {
    if (coins >= cost_axolotl) {
      coins -= cost_axolotl;
      let empty = grid.map((v,i)=>v===0?i:-1).filter(i=>i!==-1);
      if (empty.length > 0) {
        let randomEmpty = empty[Math.floor(Math.random() * empty.length)];
        grid[randomEmpty] = 1;
        updateIncome();
        renderGrid();
        updateDisplay();
        if (consentGiven) saveToLocalStorage();
      } else {
        showSaveFeedback("No empty space! Expand your grid.");
      }
    } else {
        showSaveFeedback("Not enough coins!");
    }
  }
  
  function buyIngot() {
      if (coins >= cost_ingot) {
          coins -= cost_ingot;
          ingots += 1 * ingotGainMultiplier;
          updateDisplay();
          checkAchievements();
          if (consentGiven) saveToLocalStorage();
      } else {
          showSaveFeedback("Not enough coins!");
      }
  }

  function buy10Ingots() {
      if (coins >= cost_10_ingots) {
          coins -= cost_10_ingots;
          ingots += 10 * ingotGainMultiplier;
          updateDisplay();
          checkAchievements();
          if (consentGiven) saveToLocalStorage();
      } else {
          showSaveFeedback("Not enough coins!");
      }
  }

  function buy100Ingots() {
      if (coins >= cost_100_ingots) {
          coins -= cost_100_ingots;
          ingots += 100 * ingotGainMultiplier;
          updateDisplay();
          checkAchievements();
          if (consentGiven) saveToLocalStorage();
      } else {
          showSaveFeedback("Not enough coins!");
      }
  }

  function expandGrid() {
      const currentCost = expand_costs[gridSize];
      if (coins >= currentCost) {
          coins -= currentCost;
          gridSize++;
          grid = grid.concat(new Array(gridSize * gridSize - grid.length).fill(0));
          expandGridBtn.textContent = `Expand Grid (Cost: ${formatNumber(expand_costs[gridSize])} Coins)`;
          if (gridSize === 4) {
              expandGridBtn.textContent = `Expand Grid (Cost: ${formatNumber(expand_costs[gridSize])} Coins)`;
          } else {
              expandGridBtn.disabled = true;
              expandGridBtn.textContent = "Grid Max Size";
          }
          renderGrid();
          updateDisplay();
          if (consentGiven) saveToLocalStorage();
      } else {
          showSaveFeedback("Not enough coins to expand the grid!");
      }
  }

  function buyAutoMerge() {
      if (autoMergeLevel < 3 && ingots >= autoMerge_costs[autoMergeLevel]) {
          ingots -= autoMerge_costs[autoMergeLevel];
          autoMergeLevel++;
          if (autoMergeInterval) clearInterval(autoMergeInterval);
          autoMergeInterval = setInterval(autoMerge, 5000 - autoMergeLevel * 1000); // Faster with each level
          autoMergeBtn.textContent = `Buy Auto Merge Lvl ${autoMergeLevel + 1} (${autoMerge_costs[autoMergeLevel]} Ingots)`;
          if (autoMergeLevel === 3) {
              autoMergeBtn.disabled = true;
              autoMergeBtn.textContent = "Max Auto Merge Level";
          }
          updateDisplay();
          checkAchievements();
          if (consentGiven) saveToLocalStorage();
      } else {
          showSaveFeedback("Not enough ingots or max level reached!");
      }
  }

  function buyGoldBadge() {
      if (ingots >= cost_gold_badge && !hasGoldBadge) {
          ingots -= cost_gold_badge;
          hasGoldBadge = true;
          goldBadgeSpan.style.display = 'inline-block';
          buyGoldBadgeBtn.disabled = true;
          buyGoldBadgeBtn.textContent = "Gold Ingot Badge Bought";
          updateDisplay();
          checkAchievements();
          if (consentGiven) saveToLocalStorage();
      } else {
          showSaveFeedback("Not enough ingots or you already own the badge!");
      }
  }

  function prestige() {
      if (coins >= prestige_cost) {
          // Calculate prestige bonus
          let prestigeBonus = Math.floor(coins / 1000000);
          ingotGainMultiplier += prestigeBonus * prestige_ingot_bonus;
          coinGainMultiplier += prestigeBonus * prestige_coin_bonus;

          // Reset game state
          prestigeBought = true;
          gridSize = 3;
          grid = new Array(gridSize * gridSize).fill(0);
          coins = 0;
          ingots = 0;
          selected = null;
          autoMergeLevel = 0;
          if (autoMergeInterval) clearInterval(autoMergeInterval);
          autoMergeInterval = null;
          highestAxolotlLevel = 0;

          // Update UI and save
          renderGrid();
          updateIncome();
          updateDisplay();
          checkAchievements();
          showSaveFeedback("Prestige successful! Your multipliers have increased!");
          hideModal();
          if (consentGiven) saveToLocalStorage();
      } else {
          showSaveFeedback("Not enough coins to prestige!");
      }
  }

  function autoMerge() {
      const highestLevel = grid.reduce((max, level) => Math.max(max, level), 0);
      if (highestLevel === 0) return;
      
      for(let level = 1; level <= highestLevel; level++) {
        let indices = grid.map((v, i) => v === level ? i : -1).filter(i => i !== -1);
        while (indices.length >= 2) {
          let idx1 = indices.pop();
          let idx2 = indices.pop();
          selectCell(idx1, gridDiv.children[idx1]);
          selectCell(idx2, gridDiv.children[idx2]);
          if (consentGiven) saveToLocalStorage();
        }
      }
  }
  
  function mergeAllOfSelectedLevel() {
    const levelToMerge = parseInt(mergeLevelInput.value);
    if (coins < cost_merge_all) {
        showSaveFeedback("Not enough coins!");
        return;
    }

    if (isNaN(levelToMerge) || levelToMerge < 1) {
        showSaveFeedback("Please enter a valid level to merge.");
        return;
    }

    const indices = grid.map((v, i) => v === levelToMerge ? i : -1).filter(i => i !== -1);
    if (indices.length < 2) {
        showSaveFeedback("Not enough axolotls of that level to merge!");
        return;
    }
    
    coins -= cost_merge_all;
    let newLevel = levelToMerge + 1;
    let emptyCells = grid.map((v,i)=>v===0?i:-1).filter(i=>i!==-1);

    if (emptyCells.length === 0) {
        showSaveFeedback("No empty space for the new axolotl!");
        return;
    }

    // Merging pairs of axolotls
    for (let i = 0; i < Math.floor(indices.length / 2); i++) {
        grid[indices[i*2]] = 0; // Clear the first axolotl
        grid[indices[i*2 + 1]] = 0; // Clear the second axolotl
        grid[emptyCells[i]] = newLevel; // Place the new, merged axolotl
        coins += newLevel * coinGainMultiplier;
        highestAxolotlLevel = Math.max(highestAxolotlLevel, newLevel);
        if (i+1 < Math.floor(indices.length / 2) && i+1 >= emptyCells.length) {
            showSaveFeedback("Not enough empty spaces to place all merged axolotls!");
            break;
        }
    }
    
    // Clear any remaining axolotls from the original level
    for (let i = Math.floor(indices.length / 2) * 2; i < indices.length; i++) {
        grid[indices[i]] = levelToMerge; // Leave them if not enough space for merged ones
    }

    updateIncome();
    renderGrid();
    updateDisplay();
    checkAchievements();
    if (consentGiven) saveToLocalStorage();
  }

  function updateIncome() {
      let income = 0;
      grid.forEach(level => {
          income += level * coinGainMultiplier;
      });
      // Cap passive income
      if (income > maxPassive) {
        income = maxPassive;
      }
      incomeSpan.textContent = formatNumber(income);
  }

  function passiveIncomeLoop() {
      let income = 0;
      grid.forEach(level => {
          income += level * coinGainMultiplier;
      });
      // Cap passive income
      if (income > maxPassive) {
        income = maxPassive;
      }
      coins += income;
      updateDisplay();
      checkAchievements();
  }

  function updateDisplay() {
      coinsSpan.textContent = formatNumber(coins);
      ingotsSpan.textContent = formatNumber(ingots);
      multiplierDisplay.textContent = `${coinGainMultiplier}x coins, ${ingotGainMultiplier}x ingots`;

      buyAxolotlBtn.textContent = `Buy Lvl 1 Axolotl (${formatNumber(cost_axolotl)} Coins)`;
      buyAxolotlBtn.disabled = coins < cost_axolotl;
      buyIngotBtn.textContent = `Buy Gold Ingot (${formatNumber(cost_ingot)} Coins)`;
      buyIngotBtn.disabled = coins < cost_ingot;
      buy10IngotsBtn.textContent = `Buy 10 Ingots (${formatNumber(cost_10_ingots)} Coins)`;
      buy10IngotsBtn.disabled = coins < cost_10_ingots;
      buy100IngotsBtn.textContent = `Buy 100 Ingots (${formatNumber(cost_100_ingots)} Coins)`;
      buy100IngotsBtn.disabled = coins < cost_100_ingots;
      mergeAllBtn.disabled = coins < cost_merge_all;

      if (gridSize < 5) {
          expandGridBtn.textContent = `Expand Grid (Cost: ${formatNumber(expand_costs[gridSize])} Coins)`;
          expandGridBtn.disabled = coins < expand_costs[gridSize];
      } else {
          expandGridBtn.disabled = true;
          expandGridBtn.textContent = "Grid Max Size";
      }

      if (autoMergeLevel < 3) {
          autoMergeBtn.textContent = `Buy Auto Merge Lvl ${autoMergeLevel + 1} (${formatNumber(autoMerge_costs[autoMergeLevel])} Ingots)`;
          autoMergeBtn.disabled = ingots < autoMerge_costs[autoMergeLevel];
      } else {
          autoMergeBtn.disabled = true;
          autoMergeBtn.textContent = "Max Auto Merge Level";
      }

      prestigeBtn.disabled = coins < prestige_cost;
      buyGoldBadgeBtn.disabled = hasGoldBadge || ingots < cost_gold_badge;
  }
  
  function checkAchievements() {
    for (const key in achievements) {
        if (!achievements[key].unlocked) {
            let unlocked = false;
            switch (achievements[key].type) {
                case 'coins':
                    unlocked = coins >= achievements[key].threshold;
                    break;
                case 'ingots':
                    unlocked = ingots >= achievements[key].threshold;
                    break;
                case 'level':
                    unlocked = highestAxolotlLevel >= achievements[key].threshold;
                    break;
                case 'automerge':
                    unlocked = autoMergeLevel >= achievements[key].threshold;
                    break;
                case 'prestige':
                    unlocked = prestigeBought;
                    break;
                case 'goldbadge':
                    unlocked = hasGoldBadge;
                    break;
            }
            if (unlocked) {
                achievements[key].unlocked = true;
                showAchievementNotification(achievements[key]);
            }
        }
    }
  }

  function showAchievementNotification(achievement) {
      achievementNotification.innerHTML = `
          <h4>Achievement Unlocked!</h4>
          <p>${achievement.icon} ${achievement.name}: ${achievement.description}</p>
      `;
      achievementNotification.classList.add('visible');
      setTimeout(() => {
          achievementNotification.classList.remove('visible');
      }, 5000); // Hides after 5 seconds
  }

  function resetGame() {
      const confirmReset = window.confirm("Are you sure you want to reset your game? This action cannot be undone.");
      if (confirmReset) {
          localStorage.removeItem("axolotlMergeGame");
          window.location.reload();
      }
  }

  function showSaveFeedback(message) {
      saveFeedback.textContent = message;
      saveFeedback.classList.add('visible');
      setTimeout(() => {
          saveFeedback.classList.remove('visible');
      }, 3000);
  }

  function getSaveData() {
      const gameState = {
          grid,
          gridSize,
          coins,
          ingots,
          axolotlName,
          autoMergeLevel,
          prestigeBought,
          ingotGainMultiplier,
          coinGainMultiplier,
          hasGoldBadge,
          highestAxolotlLevel,
          achievements
      };
      return gameState;
  }

  function applyGameData(data) {
      grid = data.grid || new Array(3 * 3).fill(0);
      gridSize = data.gridSize || 3;
      coins = data.coins || 50;
      ingots = data.ingots || 0;
      axolotlName = data.axolotlName || "";
      axolotlNameInput.value = axolotlName;
      autoMergeLevel = data.autoMergeLevel || 0;
      prestigeBought = data.prestigeBought || false;
      ingotGainMultiplier = data.ingotGainMultiplier || 1;
      coinGainMultiplier = data.coinGainMultiplier || 1;
      hasGoldBadge = data.hasGoldBadge || false;
      highestAxolotlLevel = data.highestAxolotlLevel || 0;
      
      const loadedAchievements = data.achievements || {};
      for (const key in achievements) {
          if (loadedAchievements[key]) {
              achievements[key] = loadedAchievements[key];
          }
      }

      if (autoMergeInterval) clearInterval(autoMergeInterval);
      if (autoMergeLevel > 0) {
          autoMergeInterval = setInterval(autoMerge, 5000 - autoMergeLevel * 1000);
      }
      
      if (hasGoldBadge) {
          goldBadgeSpan.style.display = 'inline-block';
      } else {
          goldBadgeSpan.style.display = 'none';
      }

      renderGrid();
      updateIncome();
      updateDisplay();
  }

  function saveToLocalStorage() {
      if (!consentGiven) return;
      const gameState = getSaveData();
      const saveData = JSON.stringify(gameState);
      const encryptedData = CryptoJS.AES.encrypt(saveData, AES_KEY).toString();
      localStorage.setItem("axolotlMergeGame", encryptedData);
  }

  function loadFromLocalStorage() {
      const encryptedData = localStorage.getItem("axolotlMergeGame");
      if (encryptedData) {
          try {
              const decryptedBytes = CryptoJS.AES.decrypt(encryptedData, AES_KEY);
              const decryptedData = decryptedBytes.toString(CryptoJS.enc.Utf8);
              const data = JSON.parse(decryptedData);
              applyGameData(data);
              showSaveFeedback("Game Loaded!");
          } catch (e) {
              console.error("Failed to decrypt or parse game data:", e);
              showSaveFeedback("Failed to load game data. Starting a new game.");
              applyGameData({});
          }
      } else {
          applyGameData({});
      }
  }

  function copySaveData() {
      const gameState = getSaveData();
      const saveData = JSON.stringify(gameState);
      const encryptedData = CryptoJS.AES.encrypt(saveData, AES_KEY).toString();

      const tempInput = document.createElement('textarea');
      tempInput.value = encryptedData;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand('copy');
      document.body.removeChild(tempInput);
      showSaveFeedback("Save ID copied to clipboard!");
  }

  function importSaveData(encryptedData) {
      try {
          const decryptedBytes = CryptoJS.AES.decrypt(encryptedData, AES_KEY);
          const decryptedData = decryptedBytes.toString(CryptoJS.enc.Utf8);
          const data = JSON.parse(decryptedData);
          applyGameData(data);
          if (consentGiven) saveToLocalStorage();
          showSaveFeedback("Save ID imported successfully!");
      } catch (e) {
          console.error("Failed to decrypt or parse imported data:", e);
          showSaveFeedback("Invalid Save ID!");
      }
  }

  function showModal(type) {
      modalContainer.style.display = 'flex';
      modalContent.innerHTML = ''; // Clear previous content

      if (type === 'import') {
          modalContent.innerHTML = `
              <h2>Import Save ID</h2>
              <p>Paste your saved game ID below.</p>
              <input type="text" id="importInput" placeholder="Paste Save ID here...">
              <button class="save-load-btn" onclick="importSaveData(document.getElementById('importInput').value); hideModal();">Import</button>
              <button class="reset-btn" onclick="hideModal()">Cancel</button>
          `;
      } else if (type === 'prestige') {
          modalContent.innerHTML = `
              <h2>Prestige</h2>
              <p>Are you sure you want to Prestige? You will lose your current game progress but gain permanent multipliers!</p>
              <p>Current Prestige Multiplier: ${coinGainMultiplier}x coins, ${ingotGainMultiplier}x ingots</p>
              <button class="prestige-btn" onclick="prestige()">Confirm Prestige</button>
              <button class="reset-btn" onclick="hideModal()">Cancel</button>
          `;
      } else if (type === 'howToPlay') {
          modalContent.innerHTML = `
              <h2>How to Play</h2>
              <p>
                  Merge two axolotls of the same level by clicking on one and then another. The new axolotl will be one level higher and you will get coins for it.
              </p>
              <p>
                  You can buy a level 1 axolotl for 10 coins. The bigger your axolotl's level is the more coins you get.
              </p>
              <p>
                  Buy gold ingots to get permanent multipliers and unlock new abilities.
              </p>
              <p>
                  Prestige once you have 1 million coins to start over with permanent coin and ingot multipliers.
              </p>
              <button class="save-load-btn" onclick="hideModal()">Got It!</button>
          `;
      } else if (type === 'consent') {
          modalContent.innerHTML = `
              <h2>Cookie Consent</h2>
              <p>This game uses local storage to save your progress. Do you consent to using local storage?</p>
              <p>If you decline, your progress will not be saved between sessions.</p>
              <button class="save-load-btn" onclick="acceptCookies()">I Consent</button>
              <button class="reset-btn" onclick="startWithoutCookies()">Decline</button>
          `;
      } else if (type === 'achievements') {
          let achievementsHtml = '<h2>Achievements</h2><ul id="achievementsList">';
          for (const key in achievements) {
              const achievement = achievements[key];
              const unlockedClass = achievement.unlocked ? 'unlocked' : '';
              const statusText = achievement.unlocked ? 'Unlocked' : 'Locked';
              const statusClass = achievement.unlocked ? 'unlocked' : 'locked';

              achievementsHtml += `
                  <li class="achievement-item ${unlockedClass}">
                      <span class="achievement-status ${statusClass}">${statusText}</span>
                      <span class="achievement-icon">${achievement.icon}</span>
                      <div class="achievement-details">
                          <h4>${achievement.name}</h4>
                          <p>${achievement.description}</p>
                      </div>
                  </li>
              `;
          }
          achievementsHtml += '</ul><button class="save-load-btn" onclick="hideModal()">Close</button>';
          modalContent.innerHTML = achievementsHtml;
      }
  }

  function hideModal() {
      modalContainer.style.display = 'none';
  }

  function acceptCookies() {
    consentGiven = true;
    localStorage.setItem("consentGiven", "true");
    hideModal();
    loadFromLocalStorage(); 
    if (autoSaveInterval) clearInterval(autoSaveInterval);
    autoSaveInterval = setInterval(saveToLocalStorage, 5000);
  }

  function startWithoutCookies() {
    consentGiven = false;
    hideModal();
    applyGameData({}); 
  }

  window.onload = () => {
    const savedConsent = localStorage.getItem("consentGiven");
    if (savedConsent === "true") {
      consentGiven = true;
      loadFromLocalStorage();
      autoSaveInterval = setInterval(saveToLocalStorage, 5000);
    } else if (savedConsent === null) {
      showModal('consent');
      // No game initialization here, will be handled by modal choice
    } else { // savedConsent === "false"
      consentGiven = false;
      applyGameData({});
    }
    setInterval(passiveIncomeLoop, 1000);
  }
</script>
</body>
</html>
